<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/redefinirSenha.css" />
  <title>Verificar Token</title>
</head>

<body style="background-color: #01303F;">
  <a href="index.html">
    <img src="assets/logo.png" alt="Logo desktop" class="fixed-logo desktop-logo">
    <img src="assets/Rectangle 51.png" alt="Logo mobile" class="fixed-logo mobile-logo">
  </a>

  <div class="container-pai">
    <!-- Coluna Esquerda -->
    <div class="bemVindo">
      <h2>Bem-vindo(a)!</h2>
      <div class="line white"></div>
      <div class="line blue"></div>
      <div class="line light-blue"></div>
    </div>

    <!-- Coluna Direita -->
    <div class="login-container atualizadaS" id="tokenDiv">
      <h2 style="color: #01303F; font-weight: 900;">Verificação de Token</h2>
      <p>Insira o token que foi enviado para o seu e-mail.</p>

      <div class="form-group">
        <img src="assets/key-solid-full.svg" alt="ícone token">
        <input type="text" id="tokenInput" name="tokenInput" required placeholder=" ">
        <label for="tokenInput">Código de Verificação</label>
      </div>

      <button onclick="verificarToken()">Verificar</button>
      <button onclick="atualizarToken()">Reenviar token</button>

      <p class="cadastro"><a href="recuperarSenha.html">Voltar</a></p>
    </div>

    <!-- Div de redefinir senha (fica oculta até token ser verificado) -->
    <div class="login-container atualizadaS" id="senhaDiv" style="display: none;">
      <h2 style="color: #01303F; font-weight: 900;">Atualizar Senha</h2>
      <p>Digite e confirme sua nova senha abaixo.</p>

      <div class="form-group">
        <img src="assets/lock-solid-full.svg" alt="ícone nova senha">
        <input type="password" id="novaSenha" name="novaSenha" required placeholder=" ">
        <label for="novaSenha">Nova Senha</label>
      </div>

      <div class="form-group">
        <img src="assets/lock-solid-full.svg" alt="ícone confirmar senha">
        <input type="password" id="confirmarSenha" name="confirmarSenha" required placeholder=" ">
        <label for="confirmarSenha">Confirmar Senha</label>
      </div>

      <button onclick="atualizarSenha()">Atualizar</button>
      <p id="mensagem" style="text-align:center; margin-top:10px;"></p>
      <p class="cadastro"><a href="login.html">Voltar para login</a></p>
    </div>
  </div>

  <!-- Alerta -->
  <div class="alerta">
    <div class="alerta-icone" id="alertaIcone">
      <img src="assets/alert.svg" alt="Alerta" id="alertaImg" />
    </div>
    <p class="alerta-texto" id="alertaTxt"></p>
  </div>

  <script>
    function mostrarAlerta(msg, tipo = "padrao") {
      const alerta = document.querySelector(".alerta");
      const alertaTxt = document.getElementById("alertaTxt");

      alerta.classList.remove("sucesso", "erro");
      if (tipo === "sucesso") alerta.classList.add("sucesso");
      if (tipo === "erro") alerta.classList.add("erro");

      alertaTxt.innerText = msg;
      alerta.style.display = "flex";
      alerta.classList.add("mostrar");

      setTimeout(() => {
        alerta.classList.remove("mostrar");
        setTimeout(() => (alerta.style.display = "none"), 500);
      }, 4000);
    }

    function atualizarSenha() {
  const novaSenha = document.getElementById("novaSenha").value.trim();
  const confirmarSenha = document.getElementById("confirmarSenha").value.trim();
  const email = localStorage.getItem("emailRecuperacao"); // recupera

  // Validações da senha
  const length = novaSenha.length >= 8;
  const number = /[0-9]/.test(novaSenha);
  const uppercase = /[A-Z]/.test(novaSenha);
  const lowercase = /[a-z]/.test(novaSenha);
  const symbol = /[^A-Za-z0-9]/.test(novaSenha);

  // Validações
  if (!email) {
    alertaImg.src = "assets/alert.svg";
    mostrarAlerta("E-mail de recuperação não encontrado. Refaça o processo.");
    return false;
  }

  if (novaSenha === "" || confirmarSenha === "") {
    alertaImg.src = "assets/alert.svg";
    mostrarAlerta("Por favor, preencha todos os campos.");
    return false;
  }

  if (!length || !number || !uppercase || !lowercase || !symbol) {
    alertaImg.src = "assets/alert.svg";
    mostrarAlerta(
      "A senha deve conter pelo menos 8 caracteres, incluindo número, letra maiúscula, minúscula e símbolo.",
      "erro"
    );
    return false;
  }

  if (novaSenha !== confirmarSenha) {
    alertaImg.src = "assets/alert.svg";
    mostrarAlerta("As senhas não coincidem.");
    return false;
  }

  // Enviando p/ o back-end
  fetch("/redefinirSenhas/atualizarSenha", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      novaSenhaServer: novaSenha,
      emailServer: email,
    }),
  })
    .then((resposta) => {
      if (resposta.ok) {
        alertaImg.src = "assets/check.svg";
        mostrarAlerta("Senha atualizada com sucesso!", "sucesso");
        localStorage.removeItem("emailRecuperacao");

        setTimeout(() => {
          window.location.href = "login.html";
        }, 2500);
      } else {
        return resposta.text().then((texto) => {
          alertaImg.src = "assets/alert.svg";
          mostrarAlerta(`Erro: ${texto}`);
        });
      }
    })
    .catch((erro) => {
      console.error("ERRO:", erro);
      alertaImg.src = "assets/alert.svg";
      mostrarAlerta("Erro de conexão com o servidor.");
    });

  return false;
}

  </script>

  <script src="js/emailFront.js"></script>
</body>
</html>
