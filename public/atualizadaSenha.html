<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/redefinirSenha.css" />
    <title>Atualizar Senha</title>
</head>

<body style="background-color: #01303F;">
    <a href="index.html">
        <img src="assets/logo.png" alt="logo" class="fixed-logo" />
    </a>

    <div class="container-pai">
        <!-- Coluna Esquerda -->
        <div class="bemVindo">
            <h2>Bem-vindo(a)!</h2>
        </div>

        <!-- Coluna Direita -->
        <div class="login-container">
            <h2 style="color: #01303F; font-weight: 900;">Atualizar Senha</h2>
            <p style="text-align:center; margin-bottom: 20px; color:#072850; font-size:14px;">
                Digite e confirme sua nova senha abaixo.
            </p>

            <div class="form-group">
                <img src="assets/lock-solid-full.svg" alt="ícone nova senha">
                <input type="password" id="novaSenha" name="novaSenha" required placeholder=" ">
                <label for="novaSenha">Nova Senha</label>
            </div>

            <div class="form-group">
                <img src="assets/lock-solid-full.svg" alt="ícone confirmar senha">
                <input type="password" id="confirmarSenha" name="confirmarSenha" required placeholder=" ">
                <label for="confirmarSenha">Confirmar Senha</label>
            </div>

            <button onclick="atualizarSenha()">Atualizar</button>
            <p id="mensagem" style="text-align:center; margin-top:10px;"></p>

            <p class="cadastro"><a href="login.html">Voltar para login</a></p>
        </div>
    </div>

    <!-- Alerta -->
    <div id="alerta" style="display:none;">
        <div class="alerta-icone" id="alertaIcone">
            <img src="assets/triangle-exclamation-solid-full.svg" alt="Alerta" id="alertaImg" />
        </div>
        <p class="alerta-texto" id="alertaTxt"></p>
    </div>
    </body>
</html>

    <script>
        // alertas
        const alerta = document.getElementById("alerta");
        const alertaIcone = document.getElementById("alertaIcone");
        const alertaImg = document.getElementById("alertaImg");
        const alertaTxt = document.getElementById("alertaTxt");

        function mostrarAlerta(msg, cor) {
            alerta.style.display = "flex";
            alertaIcone.style.backgroundColor = cor;
            alertaTxt.innerText = msg;
            alerta.classList.add("mostrar");

            setTimeout(() => {
                alerta.classList.remove("mostrar");
                setTimeout(() => (alerta.style.display = "none"), 500);
            }, 5000);
        }

       function atualizarSenha() {
  const novaSenha = document.getElementById("novaSenha").value.trim();
  const confirmarSenha = document.getElementById("confirmarSenha").value.trim();
  const email = localStorage.getItem("emailRecuperacao"); // recupera

  // Regras de segurança da senha
  const length = novaSenha.length >= 8;
  const number = /[0-9]/.test(novaSenha);
  const uppercase = /[A-Z]/.test(novaSenha);
  const lowercase = /[a-z]/.test(novaSenha);
  const symbol = /[^A-Za-z0-9]/.test(novaSenha);

  // Validações
  if (!email) {
    alertaImg.src = "assets/triangle-exclamation-solid-full.svg";
    mostrarAlerta("E-mail de recuperação não encontrado. Refaça o processo.", "red");
    return false;
  }

  if (novaSenha === "" || confirmarSenha === "") {
    alertaImg.src = "assets/triangle-exclamation-solid-full.svg";
    mostrarAlerta("Por favor, preencha todos os campos.", "red");
    return false;
  }

  if (!length || !number || !uppercase || !lowercase || !symbol) {
    alertaImg.src = "assets/triangle-exclamation-solid-full.svg";
    mostrarAlerta("A senha deve conter pelo menos 8 caracteres, incluindo número, letra maiúscula, minúscula e símbolo.", "red");
    return false;
  }

  if (novaSenha !== confirmarSenha) {
    alertaImg.src = "assets/triangle-exclamation-solid-full.svg";
    mostrarAlerta("As senhas não coincidem.", "red");
    return false;
  }

  // Envio para o back-end
  fetch("/redefinirSenhas/atualizarSenha", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      novaSenhaServer: novaSenha,
      emailServer: email
    }),
  })
  .then((resposta) => {
    if (resposta.ok) {
      alertaImg.src = "assets/check-solid-full.svg";
      mostrarAlerta("Senha atualizada com sucesso!", "green");
      localStorage.removeItem("emailRecuperacao");

      setTimeout(() => {
        window.location.href = "login.html";
      }, 2500);
    } else {
      return resposta.text().then((texto) => {
        alertaImg.src = "assets/triangle-exclamation-solid-full.svg";
        mostrarAlerta(`Erro: ${texto}`, "red");
      });
    }
  })
  .catch((erro) => {
    console.error("ERRO:", erro);
    alertaImg.src = "assets/triangle-exclamation-solid-full.svg";
    mostrarAlerta("Erro de conexão com o servidor.", "red");
  });

  return false;
}

    </script>
