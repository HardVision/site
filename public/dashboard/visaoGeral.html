<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hardvision • Dashboard</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/visaoGeral.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="iniciarPainel()">
   <div class="sidebar">

  <div class="perfil-container">
    <div class="foto-usuario">
      <i class="fa-solid fa-user"></i>
    </div>
    <div class="nome-usuario" id="nome_usuario">Nome do Usuário</div>
    <div class="cargo-usuario" id="cargo_usuario">Cargo do Usuário</div>
  </div>

  <div class="nav-lateral">
    <a href="visaoGeral.html" class="nav-item ativo"><i class="fa-solid fa-compass"></i> Visão Geral</a>
    <a href="dashboard.html" class="nav-item"><i class="fa-solid fa-chart-simple"></i> Monitoramento</a>
    <a href="alertas.html" class="nav-item"><i class="fa-solid fa-bell"></i> Alertas</a>
    <a href="metricas.html" class="nav-item"><i class="fa-solid fa-magnifying-glass-chart"></i> Métricas</a>
    <a href="perfil.html" class="nav-item"><i class="fa-solid fa-user"></i> Perfil</a>
    <a href="../login.html" class="nav-item"><i class="fa-solid fa-door-open"></i> Sair</a>
  </div>

</div>

    <main class="conteudo">

        <section class="options">
            <h1>Visão Geral</h1>
            <button id="btnNovaPostagem">Relatar incidente</button>
            <select id="tempo" onchange="atualizarDados()">
                <option value="24h">Últimas 24h</option>
                <option value="7d">Últimos 7 dias</option>
                <option value="30d">Últimos 30 dias</option>
            </select>
        </section>

        <section class="kpis kpis-gerais">
            <div class="kpi geral preto">
                <p><strong>Quantidade de máquinas</strong></p>
                <p id="kpi_cpu">3</p>
            </div>
            <div class="kpi geral verde">
                <p><strong>Máquinas em uptime</strong></p>
                <p id="kpi_ram geral">3</p>
            </div>
            <div class="kpi geral verde">
                <p><strong>Máquinas em downtime</strong></p>
                <p id="kpi_disco">0</p>
            </div>
        </section>

        <section class="viewport">
            <div class="painel" id="painelMensagens">
                <h2>Postagens de Funcionários</h2>
                <div id="postagens"></div>
            </div>
        </section>

        <div class="popup-overlay" id="popupOverlay">
            <div class="popup">
                <h2>Nova Postagem</h2>
                <label>Autor:</label>
                <span id="autor"></span>
                <label>Título:</label>
                <input type="text" id="tituloInput" placeholder="Título da postagem">
                <label>Descrição:</label>
                <textarea id="descricaoInput" placeholder="Digite a descrição..."></textarea>

                <div class="popup-acoes">
                    <button id="btnSalvar" class="botao editar" onclick="cadastrar()">Salvar</button>
                    <button id="btnCancelar" class="botao deletar">Cancelar</button>
                </div>
            </div>
        </div>

    </main>

    <script src="../js/visaoGeral.js"></script>
</body>

</html>

<script>
    const fkEmpresa = sessionStorage.EMPRESA;
    const idFuncionario = sessionStorage.ID;
    var idBotaoEscolhido = 0;
    var slt = "24h";
    pegarUptime();

    function atualizarEscolhido(id) {
        idBotaoEscolhido = id;
    }

    function mudarFiltro() {
        slt = document.getElementById("tempo").value;
        atualizarDados();
    }

    function iniciarPainel() {
        atualizarDados();
        let nomeUsuario = document.getElementById("nome_usuario");
        nomeUsuario.innerHTML = sessionStorage.NOME;
        
        let cargoUsuario = document.getElementById("cargo_usuario");
        cargoUsuario.innerHTML = sessionStorage.PERMISSAO;

        let autor = document.getElementById("autor");
        autor.innerHTML = sessionStorage.NOME;
    }
    
    function atualizarDados() {
        const postagem = document.getElementById("postagens")
        fetch(`/visaoGeral/buscar/${fkEmpresa}/${slt}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                postagem.innerHTML = "";
                for(var i = 0; i < json.length; i++) {
                    dataSeparado = json[i].DtIncidente.split("T");
                    anomesdia = dataSeparado[0].split("-")

                    horarioCorrigido = dataSeparado[1].split(".")[0]

                    dataFormatada = `${anomesdia[2]}/${anomesdia[1]}/${anomesdia[0]} ${horarioCorrigido}`
                    postagem.innerHTML += `
                    <div class="mensagem">
                        <p><span class="label">Autor:</span> <span id="autor${i}">${json[i].Nome}</span></p>
                        <p><span class="label">Título:</span>  <span id="titulo${i}">${json[i].Titulo}</span></p>
                        <p><span class="label">Data da postagem:</span> <span id="data${i}">${dataFormatada}</span></p>
                        <p><span class="label">Descrição:</span> <span id="descricao${i}">${json[i].Descricao}</span></p>
    
                        <div class="acoes">
                            <button class="botao editar" id="salvar${i}" onclick="atualizar(${i}, ${json[i].Id})">Editar</button>
                            <button class="botao deletar" id="remover${i}" onclick="deletar(${i}, ${json[i].Id})">Deletar</button>
                        </div>
                    </div>
                    `
                };
            })
        })
    }
    function pegarUptime() {
        fetch(`/visaoGeral/uptime/${fkEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                let kpi = document.getElementById("kpi_ram geral");
                kpi.innerHTML = `${json[0].Qtd}`;
                setTimeout(() => pegarUptime(), 2000);
            })
        })
    }

    function cadastrar() {
        var tituloInput = document.getElementById("tituloInput").value;
        var descricaoInput = document.getElementById("descricaoInput").value;

        fetch(`/visaoGeral/cadastrar`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idFuncionarioServer: idFuncionario,
                fkEmpresaServer: fkEmpresa,
                tituloServer: tituloInput,
                descricaoServer: descricaoInput
            })
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                atualizarDados();
            })
        })
    }

    function atualizar(num, id) {

        var titulo = document.getElementById(`titulo${num}`);
        var data = document.getElementById(`data${num}`);
        var descricao = document.getElementById(`descricao${num}`);
        var salvar = document.getElementById(`salvar${num}`);
        var remover = document.getElementById(`remover${num}`);
            
        const tituloInput = document.createElement('input');
        tituloInput.value = titulo.textContent;
        tituloInput.id = titulo.id;
        titulo.parentNode.replaceChild(tituloInput, titulo);

        // const dataInput = document.createElement('input');
        // dataInput.value = data.textContent;
        // dataInput.id = data.id;
        // data.parentNode.replaceChild(dataInput, data);

        const descricaoInput = document.createElement('input');
        descricaoInput.value = descricao.textContent;
        descricaoInput.id = descricao.id;
        descricao.parentNode.replaceChild(descricaoInput, descricao);
        
        const salvarButton = document.createElement('button');
        salvarButton.textContent = "Salvar";
        salvarButton.id = salvar.id
        salvarButton.setAttribute("onclick", `enviarMudanca(${num}, ${id})`);
        salvarButton.setAttribute("class", "botao editar");
        salvar.parentNode.replaceChild(salvarButton, salvar);

        const cancelarButton = document.createElement('button');
        cancelarButton.textContent = "Cancelar";
        cancelarButton.id = remover.id
        cancelarButton.setAttribute("onclick", `fechar(${num}, ${id})`);
        cancelarButton.setAttribute("class", "botao deletar");
        remover.parentNode.replaceChild(cancelarButton, remover);
    }

    function enviarMudanca(num, id) {
        var titulo = document.getElementById(`titulo${num}`);
        var descricao = document.getElementById(`descricao${num}`);

        console.log(id);

        fetch(`/visaoGeral/atualizar`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idServer: id,
                tituloServer: titulo.value,
                descricaoServer: descricao.value,
            })
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json);
                fechar(num, id)
                atualizarDados();
            })
        })
    }

    function fechar(num, id) {
        var titulo = document.getElementById(`titulo${num}`);
        var data = document.getElementById(`data${num}`);
        var descricao = document.getElementById(`descricao${num}`);
        var salvar = document.getElementById(`salvar${num}`);
        var remover = document.getElementById(`remover${num}`);
            
        const tituloSpan = document.createElement('span');
        tituloSpan.textContent = titulo.value;
        tituloSpan.id = titulo.id;
        titulo.parentNode.replaceChild(tituloSpan, titulo);

        // const dataSpan = document.createElement('span');
        // dataSpan.textContent = data.value;
        // dataSpan.id = data.id;
        // data.parentNode.replaceChild(dataSpan, data);

        const descricaoSpan = document.createElement('span');
        descricaoSpan.textContent = descricao.value;
        descricaoSpan.id = descricao.id;
        descricao.parentNode.replaceChild(descricaoSpan, descricao);
        
        const salvarButton = document.createElement('button');
        salvarButton.textContent = "Editar";
        salvarButton.id = salvar.id
        salvarButton.setAttribute("onclick", `atualizar(${num}, ${id})`);
        salvarButton.setAttribute("class", "botao editar");
        salvar.parentNode.replaceChild(salvarButton, salvar);

        const cancelarButton = document.createElement('button');
        cancelarButton.textContent = "Deletar";
        cancelarButton.id = remover.id
        cancelarButton.setAttribute("onclick", `deletar(${id})`);
        cancelarButton.setAttribute("class", "botao deletar");
        remover.parentNode.replaceChild(cancelarButton, remover);
    }

    function deletar(id) {
        atualizarEscolhido(id)
        fetch(`/visaoGeral/deletar/${idBotaoEscolhido}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                atualizarDados();
            })
        })
    }
</script>