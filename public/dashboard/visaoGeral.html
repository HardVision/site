<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hardvision • Dashboard</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/visaoGeral.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="atualizarDados()">
   <div class="sidebar">

  <div class="perfil-container">
    <div class="foto-usuario">
      <i class="fa-solid fa-user"></i>
    </div>
    <div class="nome-usuario">Nome do Usuário</div>
    <div class="cargo-usuario">Cargo do Usuário</div>
  </div>

  <div class="nav-lateral">
    <a href="visaoGeral.html" class="nav-item ativo"><i class="fa-solid fa-compass"></i> Visão Geral</a>
    <a href="dashboard.html" class="nav-item"><i class="fa-solid fa-chart-simple"></i> Monitoramento</a>
    <a href="alertas.html" class="nav-item"><i class="fa-solid fa-bell"></i> Alertas</a>
    <a href="metricas.html" class="nav-item"><i class="fa-solid fa-magnifying-glass-chart"></i> Métricas</a>
    <a href="perfil.html" class="nav-item"><i class="fa-solid fa-user"></i> Perfil</a>
    <a href="../login.html" class="nav-item"><i class="fa-solid fa-door-open"></i> Sair</a>
  </div>

</div>

    <main class="conteudo">

        <section class="options">
            <h1>Visão Geral</h1>
            <button id="btnNovaPostagem">Relatar incidente</button>
            <select id="tempo" onchange="iniciarPainel()">
                <option value="24h">Últimas 24h</option>
                <option value="7d">Últimos 7 dias</option>
                <option value="30d">Últimos 30 dias</option>
            </select>
        </section>

        <section class="kpis kpis-gerais">
            <div class="kpi geral preto">
                <p><strong>Quantidade de máquinas</strong></p>
                <p id="kpi_cpu">3</p>
            </div>
            <div class="kpi geral verde">
                <p><strong>Máquinas em uptime</strong></p>
                <p id="kpi_ram geral">3</p>
            </div>
            <div class="kpi geral verde">
                <p><strong>Máquinas em downtime</strong></p>
                <p id="kpi_disco">0</p>
            </div>
        </section>

        <section class="viewport">
            <div class="painel" id="painelMensagens">
                <h2>Postagens de Funcionários</h2>
                <div id="postagens"></div>
            </div>
        </section>

        <div class="popup-overlay" id="popupOverlay">
            <div class="popup">
                <h2>Nova Postagem</h2>
                <label>Autor:</label>
                <input type="text" id="autorInput" placeholder="Seu nome">
                <label>Título:</label>
                <input type="text" id="tituloInput" placeholder="Título da postagem">
                <label>Descrição:</label>
                <textarea id="descricaoInput" placeholder="Digite a descrição..."></textarea>

                <div class="popup-acoes">
                    <button id="btnSalvar" class="botao editar" onclick="cadastrar()">Salvar</button>
                    <button id="btnCancelar" class="botao deletar">Cancelar</button>
                </div>
            </div>
        </div>

    </main>

    <script src="../js/visaoGeral.js"></script>
</body>

</html>

<script>
    const fkEmpresa = sessionStorage.EMPRESA;
    const idFuncionario = sessionStorage.ID;
    var idBotaoEscolhido = 0;
    var slt = "24h";
    pegarUptime();

    function atualizarEscolhido(id) {
        idBotaoEscolhido = id;
    }

    function mudarFiltro() {
        slt = document.getElementById("tempo").value;
        atualizarDados();
    }

    function iniciarPainel() {
        atualizarDados();
    }
    
    function atualizarDados() {
        const postagem = document.getElementById("postagens")
        fetch(`/visaoGeral/buscar/${fkEmpresa}/${slt}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                postagem.innerHTML = "";
                for(var i = 0; i < json.length; i++) {
                    dataSeparado = json[i].DtIncidente.split("T");
                    anomesdia = dataSeparado[0].split("-")

                    horarioCorrigido = dataSeparado[1].split(".")[0]

                    dataFormatada = `${anomesdia[2]}/${anomesdia[1]}/${anomesdia[0]} ${horarioCorrigido}`
                    postagem.innerHTML += `
                    <div class="mensagem">
                        <p><span class="label">Autor:</span> ${json[i].Nome}</p>
                        <p><span class="label">Título:</span>  ${json[i].Titulo}</p>
                        <p><span class="label">Data da postagem:</span> ${dataFormatada}</p>
                        <p><span class="label">Descrição:</span> ${json[i].Descricao}</p>
    
                        <div class="acoes">
                            <button class="botao editar" onclick="atualizarEscolhido(${json[i].Id})">Editar</button>
                            <button class="botao deletar" onclick="deletar(${json[i].Id})">Deletar</button>
                        </div>
                    </div>
                    `
                };
            })
        })
    }
    function pegarUptime() {
        fetch(`/visaoGeral/uptime/${fkEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                let kpi = document.getElementById("kpi_ram geral");
                kpi.innerHTML = `${json[0].Qtd}`;
                setTimeout(() => pegarUptime(), 2000);
            })
        })
    }

    function cadastrar() {
        var tituloInput = document.getElementById("tituloInput").value;
        var descricaoInput = document.getElementById("descricaoInput").value;

        fetch(`/visaoGeral/cadastrar`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idFuncionarioServer: idFuncionario,
                fkEmpresaServer: fkEmpresa,
                tituloServer: tituloInput,
                descricaoServer: descricaoInput
            })
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                atualizarDados();
            })
        })
    }

    function deletar(id) {
        atualizarEscolhido(id)
        fetch(`/visaoGeral/deletar/${idBotaoEscolhido}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(resposta => {
            resposta.json()
            .then(json => {
                console.log(json)
                atualizarDados();
            })
        })
    }
</script>